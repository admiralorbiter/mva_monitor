{% extends "base.html" %}

{% block title %}View MVA Data{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table.css') }}">
{% endblock %}

{% block content %}
<h1>MVA Data</h1>

<!-- Search and Filter Form -->
<form method="get" action="{{ url_for('view_mva_data') }}" class="mb-4">
    <div class="form-row align-items-end">
        <div class="form-group col-md-4 col-lg-3">
            <label for="full_name">Full Name</label>
            <input type="text" class="form-control" id="full_name" name="full_name" placeholder="Enter full name" value="{{ request.args.get('full_name', '') }}">
        </div>
        <div class="form-group col-md-4 col-lg-3">
            <label for="school_name">School Name</label>
            <select class="form-control" id="school_name" name="school_name">
                <option value="">Select a School</option>
                {% for school in schools %}
                <option value="{{ school.school_name }}" {% if school.school_name == request.args.get('school_name', '') %}selected{% endif %}>
                    {{ school.school_name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-4 col-lg-2">
            <label for="results_per_page">Results per Page</label>
            <select class="form-control" id="results_per_page" name="results_per_page">
                <option value="10" {% if request.args.get('results_per_page', 10) == '10' %}selected{% endif %}>10</option>
                <option value="25" {% if request.args.get('results_per_page', 10) == '25' %}selected{% endif %}>25</option>
                <option value="50" {% if request.args.get('results_per_page', 10) == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if request.args.get('results_per_page', 10) == '100' %}selected{% endif %}>100</option>
            </select>
        </div>
        <div class="form-group col-md-4 col-lg-2">
            <button type="submit" class="btn btn-primary btn-block">Search</button>
        </div>
    </div>
</form>

<table class="table">
    <thead>
        <tr>
            <th>
                <a href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by='state_id', sort_order='asc' if sort_by != 'state_id' or sort_order == 'desc' else 'desc') }}">
                    State ID
                </a>
            </th>
            <th>
                <a href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by='school_name', sort_order='asc' if sort_by != 'school_name' or sort_order == 'desc' else 'desc') }}">
                    School Name
                </a>
            </th>
            <th>
                <a href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by='first_name', sort_order='asc' if sort_by != 'first_name' or sort_order == 'desc' else 'desc') }}">
                    First Name
                </a>
            </th>
            <th>
                <a href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by='last_name', sort_order='asc' if sort_by != 'last_name' or sort_order == 'desc' else 'desc') }}">
                    Last Name
                </a>
            </th>
            <th>
                <a href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by='grade_year', sort_order='asc' if sort_by != 'grade_year' or sort_order == 'desc' else 'desc') }}">
                    Grade Year
                </a>
            </th>
            <th>
                <a href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by='description', sort_order='asc' if sort_by != 'description' or sort_order == 'desc' else 'desc') }}">
                    MVA Progress
                </a>
            </th>
        </tr>
    </thead>
    <tbody id="mvaTableBody">
        {% for mva in mva_records.items %}
        <tr>
            <td>{{ mva.student.state_id }}</td>
            <td>{{ mva.student.school.school_name }}</td>
            <td>{{ mva.student.first_name }}</td>
            <td>{{ mva.student.last_name }}</td>
            <td>{{ mva.student.grade_year }}</td>
            <td>
                {% if 'completed' in mva.description %}
                    <i class="fas fa-check-circle icon-green" title="{{ mva.description }}"></i> 
                    {{ mva.description }}
                {% elif 'working on' in mva.description %}
                    <i class="fas fa-exclamation-circle icon-yellow" title="{{ mva.description }}"></i> 
                    {{ mva.description }}
                {% elif 'no known' in mva.description %}
                    <i class="fas fa-times-circle icon-red" title="{{ mva.description }}"></i> 
                    {{ mva.description }}
                {% else %}
                    {{ mva.description }}
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination Controls -->
<nav aria-label="Page navigation">
    <ul class="pagination">
        {% if mva_records.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by=sort_by, sort_order=sort_order) }}">First</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('view_mva_data', page=mva_records.prev_num, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by=sort_by, sort_order=sort_order) }}">Previous</a>
        </li>
        {% endif %}

        {% if start_page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('view_mva_data', page=1, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by=sort_by, sort_order=sort_order) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endif %}

        {% for page_num in range(start_page, end_page + 1) %}
        <li class="page-item {% if page_num == mva_records.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('view_mva_data', page=page_num, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by=sort_by, sort_order=sort_order) }}">{{ page_num }}</a>
        </li>
        {% endfor %}

        {% if end_page < mva_records.pages %}
        {% if end_page < mva_records.pages - 1 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('view_mva_data', page=mva_records.pages, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by=sort_by, sort_order=sort_order) }}">{{ mva_records.pages }}</a>
        </li>
        {% endif %}

        {% if mva_records.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('view_mva_data', page=mva_records.next_num, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by=sort_by, sort_order=sort_order) }}">Next</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('view_mva_data', page=mva_records.pages, full_name=request.args.get('full_name', ''), school_name=request.args.get('school_name', ''), results_per_page=request.args.get('results_per_page', 10), sort_by=sort_by, sort_order=sort_order) }}">Last</a>
        </li>
        {% endif %}
    </ul>
</nav>

<script>
function sortTable(columnIndex) {
    const table = document.querySelector('.table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const isAscending = tbody.dataset.sortOrder === 'asc';

    rows.sort((a, b) => {
        const aText = a.children[columnIndex].innerText;
        const bText = b.children[columnIndex].innerText;

        return isAscending 
            ? aText.localeCompare(bText) 
            : bText.localeCompare(aText);
    });

    // Clear the existing rows and append the sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));

    // Toggle sort order
    tbody.dataset.sortOrder = isAscending ? 'desc' : 'asc';
}
</script>
{% endblock %} 